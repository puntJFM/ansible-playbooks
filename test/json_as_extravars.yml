---
- name: Debug JSON extra vars
  hosts: localhost
  gather_facts: no

  tasks:

    - name: Show key vars passed in
      debug:
        msg:
          - "controller_username: {{ controller_username | default('NOT SET') }}"
          - "controller_password: {{ controller_password | default('NOT SET') }}"
          - "controller_host: {{ controller_host | default('NOT SET') }}"
          - "dbi_api_url: {{ dbi_api_url | default('NOT SET') }}"
          - "ccp_app_id: {{ ccp_app_id | default('NOT SET') }}"

    - name: Use DBI API token
      debug:
        msg: "Token from env: {{ lookup('env', 'dbi_api_auth_token') }}"
  
    - name: Print all variables for debugging
      debug:
        var: vars

    - name: Print raw extra_vars from hostvars
      debug:
        var: hostvars[inventory_hostname].extra_vars
      when: hostvars[inventory_hostname].extra_vars is defined

    - name: Convert extra_vars from hostvars if needed
      set_fact:
        extra_vars_dict: "{{ hostvars[inventory_hostname].extra_vars | from_json if hostvars[inventory_hostname].extra_vars is string else hostvars[inventory_hostname].extra_vars }}"
      when: hostvars[inventory_hostname].extra_vars is defined

    - name: Print parsed extra_vars_dict
      debug:
        var: extra_vars_dict
      when: extra_vars_dict is defined
